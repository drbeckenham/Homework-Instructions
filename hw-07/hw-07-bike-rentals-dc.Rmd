---
title: "HW 07 - Bike rentals in DC"
author: "[Your Name]"
output: 
  tufte::tufte_html:
    css: ../hw.css
    tufte_variant: "envisioned"
    highlight: pygments
  tufte::tufte_handout:
    latex_engine: xelatex
    highlight: pygments
    keep_tex: true
    citation_package: natbib
link-citations: true
---

```{r include = FALSE}
knitr::opts_chunk$set(
  eval = FALSE,
  out.width = "80%",
  fig.asp = 0.618,
  fig.width = 10,
  dpi = 300
)
```

```{r photo, fig.margin = TRUE, echo = FALSE, fig.width = 3, fig.cap = "Photo by Viktor Kern on Unsplash", eval = TRUE}
knitr::include_graphics("img/viktor-kern-UdGEXZtlx-E-unsplash.jpg")
```

Bike sharing systems are new generation of traditional bike rentals where whole process from membership, rental and return back has become automatic. Through these systems, user is able to easily rent a bike from a particular position and return back at another position. Currently, there are about over 500 bike-sharing programs around the world which is composed of over 500 thousands bicycles. Today, there exists great interest in these systems due to their important role in traffic, environmental and health issues.

Apart from interesting real world applications of bike sharing systems, the characteristics of data being generated by these systems make them attractive for the research. Opposed to other transport services such as bus or subway, the duration of travel, departure and arrival position is explicitly recorded in these systems. This feature turns bike sharing system into a virtual sensor network that can be used for sensing mobility in the city. Hence, it is expected that most of important events in the city could be detected via monitoring these data.

Source: [UCI Machine Learning Repository - Bike Sharing Dataset](http://archive.ics.uci.edu/ml/datasets/Bike+Sharing+Dataset)

# Getting started

Open the `hw-07-bike-rentals-dc.rmd` file in your RStudio Notebook on JupyterHub. Knit the document to make sure it compiles without errors.

## Learning Objectives

In this assignment, you will practice:

- Recoding variables into factors with meaningful levels
- Creating new variables through calculations
- Validating data integrity
- Creating effective data visualizations
- Fitting and interpreting linear regression models
- Working with interaction terms in models


## Warm up

Before we introduce the data, let's warm up with some simple exercises. Update the YAML of your R Markdown file with your information, knit, commit, and push your changes. Make sure to commit with a meaningful commit message. Then, go to your repo on GitHub and confirm that your changes are visible in your Rmd **and** md files. If anything is missing, commit and push again.

## Packages

We'll use the **tidyverse** package for much of the data wrangling and visualisation and the data lives in the **dsbox** package. These packages are already installed for you. You can load them by running the following in your Console:

```{r load-packages, message = FALSE, eval = TRUE}
library(tidyverse)
library(dsbox)
```

## Data

The data can be found in the **dsbox** package, and it's called `dcbikeshare`. Since the dataset is distributed with the package, we don't need to load it separately; it becomes available to us when we load the package. You can find out more about the dataset by inspecting its documentation, which you can access by running `?dcbikeshare` in the Console or using the Help menu in RStudio to search for `dcbikeshare`. You can also find this information [here](https://rstudio-education.github.io/dsbox/reference/dcbikeshare.html).

The data include daily bike rental counts (by members and casual users) of Capital Bikeshare in Washington, DC in 2011 and 2012 as well as weather information on these days. The original data sources are <http://capitalbikeshare.com/system-data> and <http://www.freemeteo.com>.

## Helpful Functions for This Assignment

**Factor Recoding:**
- `factor(variable, levels = c(...), labels = c(...))` - Convert to factor with specific levels and labels
- The first level specified becomes the baseline (reference) level

**Creating New Variables:**
- `mutate(new_var = old_var * constant)` - Create calculated variables

**Validation:**
- `all(condition)` - Check if all values meet a condition
- Logical operators: `==` (equal), `!=` (not equal)

**Modeling:**
- `lm(y ~ x, data = data)` - Fit a linear model
- `summary(model)` - View model output including coefficients and R²
- `y ~ x1 + x2` - Multiple predictors
- `y ~ x1 * x2` - Include interaction between x1 and x2
- Adjusted R² is found in the model summary output

**Tip:** For questions 1-6, save your recoded/calculated variables back to the dataset so you can use them in later questions.

# Exercises

## Data wrangling

1.  Recode the `season` variable to be a factor with meaningful level names as outlined in the codebook, with spring as the baseline level.

2.  Recode the binary variables `holiday` and `workingday` to be factors with levels no (0) and yes (1), with no as the baseline level.

3.  Recode the `yr` variable to be a factor with levels 2011 and 2012, with 2011 as the baseline level.

4.  Recode the `weathersit` variable as 1 - clear, 2 - mist, 3 - light precipitation, and 4 - heavy precipitation, with clear as the baseline.

5.  Calculate raw temperature, feeling temperature, humidity, and windspeed as their values given in the dataset multiplied by the maximum raw values stated in the codebook for each variable. Instead of writing over the existing variables, create new ones with concise but informative names.

6.  Check that the sum of `casual` and `registered` adds up to `cnt` for each record. This is a data validation step to ensure the dataset is internally consistent.

One way to do this is to create a new logical variable that checks if `casual + registered == cnt` for each row, then verify that all values are `TRUE`.

**Write your answer:** Do the casual and registered counts sum to the total count for all records? (Yes/No)

**Checkpoint:** Before moving on to exploratory data analysis and modeling, verify your data wrangling:

- Run `str(dcbikeshare)` to check that your factor variables show the correct levels

- Check that your new calculated variables (raw temperature, humidity, etc.) have reasonable values

- Verify that all validations passed

If something looks wrong, revisit your data wrangling code before continuing.

Knit, *commit, and push your changes to GitHub with an appropriate commit message. Make sure to commit and push all changed files so that your Git pane is cleared up afterwards.*

## Exploratory data analysis

7.  The code below creates a visualization showing the relationship between date, bike rentals, and feeling temperature. Examine the code and visualization, then answer the questions.

```{r fig.fullwidth = TRUE, echo=FALSE, eval=TRUE}
dcbikeshare %>%
  mutate(atemp_raw = atemp * 50) %>%
  ggplot(mapping = aes(x = dteday, y = cnt, color = atemp_raw)) +
    geom_point(alpha = 0.7) +
    labs(
      title = "Bike rentals in DC, 2011 and 2012",
      subtitle = "Warmer temperatures associated with more bike rentals",
      x = "Date",
      y = "Bike renrals",
      color = "Temperature (C)"
    ) +
  theme_minimal()
```

  a. What does this visualization reveal about the relationship   between temperature and bike rentals over time?

  b. Modify the code to color the points by humidity instead of temperature. What new pattern (if any) emerges?
  
```{r bike-humidity-viz}
# Your modified code here
```

8.  Create a visualization displaying the relationship between bike rentals and season. Interpret the plot in context of the data.

Knit, *commit, and push your changes to GitHub with an appropriate commit message. Make sure to commit and push all changed files so that your Git pane is cleared up afterwards.*

## Modeling

9.  Fit a linear model predicting total daily bike rentals from daily temperature. Write the linear model, interpret the slope and the intercept in context of the data, and determine and interpret the $R^2$.

10. Fit another linear model predicting total daily bike rentals from daily feeling temperature. Write the linear model, interpret the slope and the intercept in context of the data, and determine and interpret the $R^2$. Is temperature or feeling temperature a better predictor of bike rentals? Explain your reasoning.

11. Fit a model predicting total daily bike rentals from season, year, whether the day is holiday or not, whether the day is a workingday or not, the weather category, temperature, feeling temperature, humidity, and windspeed, as well as the interaction between feeling temperature and holiday. Record adjusted $R^2$ of the model.

12. Your model in Question 11 includes an interaction between feeling temperature and holiday. Write out the linear model equation for holidays and the linear model equation for non-holidays separately (substitute the appropriate values for the holiday variable). Is the slope of temperature the same or different for these two models? How about the slope for feeling temperature? Explain why based on the interaction term.

13. Interpret the slopes of season and feeling temperature in the context of bike rentals. If the slopes are different for holidays and non-holidays, make sure to interpret both. If the variable has multiple levels, make sure you interpret all of the slope coefficients associated with it.

14. Interpret the intercept in the context of bike rentals. If the intercept is different for holidays and non-holidays, make sure to interpret both.

15. According to this model, assuming everything else is the same, in which season does the model predict total daily bike rentals to be highest and which to be the lowest?

Knit, *commit, and push your changes to GitHub with an appropriate commit message. Make sure to commit and push all changed files so that your Git pane is cleared up afterwards and review the md document on GitHub to make sure you're happy with the final state of your work.*

Now go back through your write up to make sure you've answered all questions and all of your R chunks are properly labeled.

Once you decide that you are done with the homework, choose the knit drop down and select `Knit to tufte_handout` to generate a pdf. Download and submit that pdf to Canvas.

---

## Common Errors and Troubleshooting

**Factor recoding issues:**
- **Error: "object not found"** after recoding → You didn't save the changes back to the dataset. Use `dcbikeshare <- dcbikeshare %>% mutate(...)`

- **Baseline level is wrong** → The first level you specify in `factor()` becomes the baseline

- **Factor levels don't match codebook** → Check spelling and capitalization in your `labels` argument

**Modeling errors:**
- **Error: "object '...' not found"** in `lm()` → Make sure you recoded/created all variables first and saved them to the dataset

- **Can't find R² or Adjusted R²** → Run `summary(model_name)` not just the model name

- **Interaction term not showing** → Use `*` not `+` between the variables you want to interact (e.g., `atemp_raw * holiday`)

**Interpretation issues:**
- **Don't know which coefficient is which** → Factor variables show as `variablenameLevel` (e.g., `seasonwinter` means winter compared to baseline)

- **Confused about interaction terms** → The interaction coefficient modifies the slope - plug in values for the interacting variable to see how slopes change

- **Intercept doesn't make sense** → Remember it's when all predictors = 0 or baseline levels, which may not be realistic

**Data wrangling:**
- **Calculated values seem wrong** → Double-check the multipliers from the codebook

- **Validation check fails** → Check for typos in variable names or logic operators
